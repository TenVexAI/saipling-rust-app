import { useEffect, useRef, useState } from 'react';
import { useThemeStore } from '../../stores/themeStore';

interface PhaseIconProps {
  phase: 'seed' | 'root' | 'sprout' | 'flourish' | 'bloom';
  size?: number;
  animate?: boolean;
}

// Each phase has: viewBox (square-cropped), fill path (st0), stroke path (st1)
const PHASE_SVG_DATA: Record<string, { viewBox: string; fill: string; stroke: string; strokeWidth: number }> = {
  seed: {
    viewBox: '500 290 600 600',
    strokeWidth: 14,
    fill: `M692.1,452.8c16.8-5.1,34.8-7.1,52.2-7.8c37.5-1.4,76.2,6,109.3,24.1c61,33.4,102.6,114.9,64.7,180.4
      c-3.9,6.7-8.5,12.9-13.6,18.7c-34.4,38.6-91.8,53.1-141.8,51.9c-35.9-0.9-71.7-14-99.1-37.2c-30.3-25.7-46.4-63.3-47.8-102.7
      c-0.5-14.7,0.2-29.7,2.4-44.3c4-26.2,18.4-50.3,39.6-66.3C668.3,462,679.9,456.6,692.1,452.8z`,
    stroke: `M798.6,414.1c14,13.7,33.6,22.3,51.1,29.2c44.7,17.8,92.1,21,138.3,32.3c37.7,9.2,77,25.7,96.4,61.5
      c30.1,55.4,5.4,121.1-44.5,155.5c-119.4,82.4-292.8,38.4-399.4-45c-68.9-53.9-113.9-152.2-69.3-235.5c14.6-27.4,45-57.3,78.3-40
      c23.3,12.2,33.5,37.2,41,61c7.7,24.2,16.3,48.1,30.9,69.2c36,51.6,95.9,76.5,158,66.1c2.6-0.4,9.3-1.9,8.2-2.2
      c-7.2-1.7-14.1-3.6-19.7-4.8c-33.5-7.3-67.9-20.2-92.2-45.4c-40-41.4-25.2-114-73.6-149.2c-8-5.8-17.2-9.7-27-11.3
      c-4.8-0.8-9.6-1-14.5-1c-12.4,0,84.4-39.7,124.5,40.9`,
  },
  root: {
    viewBox: '540 250 570 570',
    strokeWidth: 13,
    fill: `M810.9,297.3c16.8-5.1,34.8-7.1,52.2-7.8c37.5-1.4,76.2,6,109.3,24.1c61,33.4,102.6,114.9,64.7,180.4
      c-3.9,6.7-8.5,12.9-13.6,18.7c-34.4,38.6-91.8,53.1-141.8,51.9c-35.9-0.9-71.7-14-99.1-37.2c-30.3-25.7-46.4-63.3-47.8-102.7
      c-0.5-14.7,0.2-29.7,2.4-44.3c4-26.2,18.4-50.3,39.6-66.3C787,306.4,798.6,301,810.9,297.3z`,
    stroke: `M569.2,801.4c0,0,64.6-33.1,96.2-8.4c2.2,1.7,12.2,10.6,7.2,13.1c-5,2.5-14.3-11.3-15.9-14.1
      c-23.5-39.2,2.2-89.4,0.8-131.2c-3.1-91.5-62.6-170.7-64.6-262.5c-0.7-29.3,6.1-58.8,24.6-82.2c28.2-35.5,76.1-46.9,119.4-40.1
      c23.1,3.6,41.6,14.1,62.8,22.9c26.3,10.8,54.7,14.3,82.6,17.9c18,2.3,36,4.7,53.7,9.1c49.9,12.3,89.6,45.5,115.1,89.7
      c18.8,32.6,29.6,70.7,30.5,108.8c0.8,33.1-4,73.9-35.2,92.7c-26.3,15.9-59.7,9-87.2,0.1c-45.8-14.8-91.6-36.3-126.7-70.5
      c-39.1-38.1-60.2-90.5-64.1-144.5c-0.8-10.9-0.9-21.9-0.3-32.8c0.9-16,17.1-22.7,30.9-24.6c67.5-9.1,117.5,44.5,156.2,92
      c14.4,17.7,29.7,35.6,47.7,49.9c4.3,3.4,7.2,8.2,5.8,8.9c-3.2,1.8-18.7-6.1-23-8.4c-21.5-11.6-39.1-28.7-54.4-47.6
      c-15.4-19.1-29.6-39.6-49.3-54.6c-20.3-15.5-45.6-26.8-71.8-26.8c-27.3,0-30.4-0.8-54.6-15.4c-25.8-15.6-59.2-8.3-78.7,14
      c-20.5,23.4-19,56.3-12.3,84.7c13.1,55.9,32.4,111.4,45.5,167.8c6.7,28.7,11.8,57.8,13.7,87.2c1.8,27.3-3.8,56.2,1,83.1
      c0.5,3.1,1.2,6.1,2.2,9.1c3,9,19.6-19.2,38-3.4c18.3,15.8,29,6.8,29,6.8`,
  },
  sprout: {
    viewBox: '525 250 600 600',
    strokeWidth: 14,
    fill: `M726,317.8c16.8-5.1,34.8-7.1,52.2-7.8c37.5-1.4,76.2,6,109.3,24.1c61,33.4,102.6,114.9,64.7,180.4
      c-3.9,6.7-8.5,12.9-13.6,18.7c-34.4,38.6-91.8,53.1-141.8,51.9c-35.9-0.9-71.7-14-99.1-37.2c-30.3-25.7-46.4-63.3-47.8-102.7
      c-0.5-14.7,0.2-29.7,2.4-44.3c4-26.2,18.4-50.3,39.6-66.3C702.1,326.9,713.7,321.5,726,317.8z`,
    stroke: `M783,829.5c0,0,35.9-17.5,55.6-3.7c1.3,0.9,3.2,0.2,3.5-1.4c3.3-17.5,5.9-42,4.3-58.7
      c-3.3-34.5-18.9-65.2-28.2-98.1c-7.8-27.3-12-55.2-18.3-82.8c-7.6-33.6-26-48.9-76.2-59.2c-50.2-10.2-98.7-14.5-114.5-60.4
      s-2.1-87.3-34-121.7c-3.8-1.7,114.5-16.2,163.9,42.6c28.4,32.3,40.3,124.5,40.6,132.2c0.3,7.7-76.1-93.3-147.9-139
      c-6-4.3,54.4,12.3,100.1,72.1s56.5,80.8,61,84.5s10.2-5.7,1.1-28.1c-9.1-22.4-8.7-47.2-8-52.4c0.6-5.1-11.3-12.1-8.7-33.2
      c2.6-21.1,13-37.7,13.8-39.2c0.9-1.5,9.6,23.8,10.4,37.2c0.9,13.4-7.4,31.1-8.9,34s2.1,21.1,6.8,30.6c4.7,9.6,7.4,13.8,8.3,17.7
      c0.9,3.8,11.3-5.7,9.9-36.9c-1.4-31.2-3.7-105.6,66.1-164s184.7-55.8,190.6-56.2c6-0.4-32.3,22.6-57.4,94.9
      c-25.1,72.4-96.6,145.7-184.8,153.8c-6.5,0.7,7.2-51.5,38.3-96.7c23.2-33.7,81.1-99.5,109.1-101.5c15,2.4-127,90.1-150.8,210.8
      c-7.7,38.8-11.1,74.6-2.5,113.6c7.6,34.3,21.8,67.5,33.2,100.9c12.3,35.9,13.6,70.3,13.6,107.9c0,0.5,0.6,0.8,1,0.5
      c8.7-5.7,20.4-9.8,30.5-6c6.4,2.4,11.1,7.8,17.6,9.8c9.2,2.9,17.9-1.1,25.2-6.7`,
  },
  flourish: {
    viewBox: '510 265 580 580',
    strokeWidth: 14,
    fill: `M770.2,457.1c16.8-5.1,34.8-7.1,52.2-7.8c37.5-1.4,76.2,6,109.3,24.1c61,33.4,102.6,114.9,64.7,180.4
      c-3.9,6.7-8.5,12.9-13.6,18.7c-34.4,38.6-91.8,53.1-141.8,51.9c-35.9-0.9-71.7-14-99.1-37.2c-30.3-25.7-46.4-63.3-47.8-102.7
      c-0.5-14.7,0.2-29.7,2.4-44.3c4-26.2,18.4-50.3,39.6-66.3C746.3,466.2,758,460.8,770.2,457.1z`,
    stroke: `M741.8,812.1c0,0,61-31.5,108-0.9c0.6,0.4,1.5,0.1,1.6-0.7c1.1-6.2,4.7-30.6,4.1-65.9
      c-0.7-41.2-10.9-70.8-22.6-88.3c-7.3-10.9-18.2-19.7-30.3-24.8c-12-5.1-25.6-4-38.2-1.9c-13.5,2.3-27.7,3.3-41.3,1.5
      c-24.7-3.3-47.4-14.9-67-29.9c-20.3-15.5-36.1-34.8-53.5-53.2c-7-7.4-14.4-14.4-22.6-20.4c-9.6-7.1-20.5-13.3-32.5-15.3
      c-5,0,94.9-34.5,166.4-6.4s81.4,95.8,83.9,104.8c2.5,9-19.1-15.6-61.7-40.5c-31-18.2-87.7-38.2-107.6-47.5
      c-17.6-8.3,68.5,6.2,118.2,44.1c49.7,37.9,48.7,48.3,66.9,61.5s23.9,7.8,24.5-5.7c0.5-13.5-2.1-88,1-117.5
      c3-29.5,7.8-53.5-8.9-72.2c-16.7-18.8-40.4-17.4-61.8-26.6c-28.4-12.3-47.9-32-60.4-60.2c-11.9-26.8-24.1-61.4-50.6-77.3
      c-3.6-2.7,184.2-9,166.6,143.1c-0.8,6-50.2-81.2-125-122.3c-6.5-3.5,29,2.5,73.9,48.2c44.9,45.7,46.4,70.2,56.9,84.4
      c10.5,14.2,17.8,14.1,20.5,6.7c2.7-7.4,8-31.1,10.4-45c0.7-3.9,1.2-3,1-3.4c-2.8-3.8-7.8-12.1-12-27.5
      c-10.1-45.6,17.1-69.6,17.5-69.3c0.7,0.6,11.8,9.6,15.8,23.5c6.9,23.5,4,41.8,0.2,53c-3.8,11.2-19.2,22.6-19,22.1
      s3.1-15.3,5.5-26.2c2.8-12.3,13.7-26.7,15.1-24.5c1.7,2.9,2.7,19.3-2.8,31.4c-4.9,10.7-17.9,19.7-18.2,19.4
      c-0.2-0.2-8.1-9.1-11.4-22.2c-2.6-10.1,2.2-20.5,2.6-20.7c0.4-0.2,3.9,4.1,7.4,11.7c3.5,7.6,4,18.1,2.5,32.4
      c-0.9,8.6-2.4,20.8-3.5,29.2c-0.7,5.6-1.6,11.2-2.6,16.8c-1.8,10.3-5.1,30.9-6.5,53.4c-0.1,2.1,0.3,4.3,1.4,6.1
      c3.1,4.9,9.6,5.3,20-6c12.6-13.7,16.9-39.3,69-82.2c52.1-42.9,90-45.2,82.8-42.3C947.3,390.4,881.2,479.5,881,473.1
      c-0.3-29.5,6.4-59.6,24.9-83.2c28.8-36.8,78.2-49.9,122.9-51.4c10.6-0.4,21.2-0.2,31.8,1c1.6,0.2,10.1,2.6,11,2.1
      c-12.7,6-22.9,15.8-31.3,26.9c-13.5,17.9-22.5,38.5-34.8,57.1c-10.9,16.5-26.3,30.3-44.3,38.6c-17.9,8.3-37.5,11.6-56.9,14.2
      c-20.4,2.7-34.7,14.2-43.3,29.5c-6,10.6-8.7,22.8-8.5,35c0.6,25,1.4,48.1,3.6,77.6c1.1,14.6,3.4,29.6,6,44.7
      c1.4,7.8,5.5,9.3,19.1-3.4c14.5-13.6,21.1-40.3,80-81.7c58.8-41.4,99.2-40.6,91.3-38.2c-88.2,27.3-163.2,116.5-162.9,109.7
      c2.1-31.4,11.6-62.8,33.1-86.4c33.5-36.8,87-46.6,134.7-44.6c11.3,0.5,22.6,1.5,33.7,3.6c1.7,0.3,10.5,3.6,11.5,3.2
      c-14,5.3-25.6,14.9-35.4,26c-15.7,17.9-27,39.1-41.6,57.8c-12.9,16.6-30.3,30-50.1,37.4c-19.6,7.4-40.8,9.3-61.6,10.5
      c-24.2,1.3-38.9,13.4-45.7,31.8c-0.7,1.9-0.9,3.9-0.5,5.9c3.1,17.9,5.7,35.3,6.2,51.3c0.7,23.5-1.4,56.2-1.8,62.9
      c0,0.7,0.5,1.3,1.2,1.3c5,0.1,24.4-0.5,53.3-15.3c33.7-17.3,59-3.8,70.2,15.3`,
  },
  bloom: {
    viewBox: '430 170 780 780',
    strokeWidth: 18,
    fill: `M690.2,374.4c24.4-7.4,50.5-10.3,75.6-11.3c54.4-2.1,110.5,8.7,158.5,35c88.4,48.4,148.8,166.7,93.8,261.5
      c-5.6,9.7-12.3,18.8-19.7,27.1c-49.9,55.9-133.1,77.1-205.6,75.3c-52-1.2-104-20.3-143.7-54c-43.9-37.3-67.3-91.7-69.3-149
      c-0.7-21.4,0.3-43,3.5-64.2c5.8-38,26.7-72.9,57.4-96.1C655.7,387.6,672.5,379.8,690.2,374.4z`,
    stroke: `M456.3,732.5c7,0,14-0.1,21-0.1c17.7-0.1,35.5-0.2,53.2-0.2c23.5-0.1,47.1-0.2,70.6-0.4
      c24.4-0.1,48.9-0.3,73.3-0.5c20.4-0.2,40.8-0.3,61.2-0.6c6.4-0.1,12.8-0.2,19.3-0.3c6.8-0.1,13.8-1.2,20.6,0.2c5,1,10,2.4,14.9,3.4
      c4.7,1.1,9.3,2.1,14,3.2c19.1,5.3,37,1.1,55.8-3c9.5-2.1,18.5-4.5,28.3-4.4c2.4,0,4.8,0,7.1,0c6.9,0,13.7,0,20.6,0c20,0,40,0,60,0
      c24.2,0,48.5,0,72.7,0c23.5,0,47,0,70.5,0c17.8,0,35.6,0,53.4,0c7.1,0,14.3,0,21.4,0l-41.1-295.3L1112,357c0,0-0.1,0-0.1,0
      c0.8,7,33.4,304,35.8,314.1c2.4,10.2,36.4,48.7,38.7,51.9c2.2,3.3-10.6-19.5-21.8-35.8c-11.9-17.3-18.1-18.9-20.4-18.9
      c-40.1,0-80.1-2.8-120.1-6.4c-37.3-3.4-76.7-12.8-113.7-2.5c-31.9,8.9-58.2,32.1-80.3,55.8c-2.7,2.9-7.2,2.7-9.7-0.2
      c-13-15.4-28.4-29.1-45.5-39.7c-32.9-20.4-69.7-20-106.9-17.2c-36.9,2.8-73.5,7.5-110.4,10.5c-18.2,1.5-36.6,2.9-54.8,1.7
      c-14.4-1.6-42.9,52.7-44.8,54.8s39-43.2,44-53.5c1.6-3.7,39.4-314.1,39.6-315.1c0.2-1-39.7,71.7-43.4,77.8
      c-3.7,6.1-37.3,270.4-42.1,285s28.5-48.5,29-50.4s28.5-259.4,28.5-259.4s26.9-52.8,29-53.3c5.4-1.4,13.1,0.5,18.7,0.6
      c14,0.3,28.2,0,42.2-2c44-6.1,87.3-21,131.9-10.9c34,7.7,63.6,27.3,86.6,53.3c6.6,6.6,6.5,273.4,6.5,310c0,2-1.4,3.8-3.3,4.1
      c-2.5,0.4-4.6-1.5-4.6-3.9c0.2-34.2,0.9-276.3,3.4-309.1c0.3-3.9,9.5-10.3,12.1-12.5c10-8.7,20.9-16.5,32.4-23.1
      c16.9-9.8,35.5-16.9,54.9-19.9c25.6-4,50.7,2,75.9,6c27.3,4.3,55,7.6,82.6,8.6c7,0.3,14.2,0.6,21.2-0.3c6.2-0.2,8.8,0,8.8,0
      l24.3,47.1l31.9,272l1.6,18.1c0,0-10.2-15.6-19.2-23.2c-1.1-0.8-3.1-1.9-3.1-1.9S1124,468.5,1124,468.5c-0.2-1.4-3.4-1.9-4.4-2.2
      c-3.1-0.8-6.3-1.2-9.5-1.5c-10.4-1.2-21-1.5-31.5-0.2c-10.2,1.2-19.5,4.2-28.8,8.4c-6.1,2.7-12.4,5.5-19.2,5.6
      c-6.5,0.1-13.2-2.6-16.5-8.5c-2.1-3.8-3-9.8,1.4-12.5c9.4-5.7,9.8,18.3-1.8,22.4s-16.5-43.2-8.1-54.6c3.1-4.2,5.2,1.7,5.7,4.4
      c1.5,7.2,0.7,15.1-0.9,22.2c-1.3,5.5-3.3,10.9-6.5,15.5c-13.2,19.5-41.6,16.1-60.7,8.8c-14.8-5.7-28.2-18-44.6-18.5
      c-12.3-0.4-23.7,7.5-28.5,18.6`,
  },
};

export function PhaseIcon({ phase, size = 50, animate = true }: PhaseIconProps) {
  const strokeRef = useRef<SVGPathElement>(null);
  const [showFill, setShowFill] = useState(!animate);
  const [drawStroke, setDrawStroke] = useState(!animate);
  const theme = useThemeStore((s) => s.theme);

  const strokeColor = theme === 'sepia' ? '#5C3D2E' : theme === 'lightPro' ? '#000000' : '#FFFFFF';
  const data = PHASE_SVG_DATA[phase];

  useEffect(() => {
    if (!animate) return;
    setShowFill(false);
    setDrawStroke(false);

    const fillTimer = setTimeout(() => setShowFill(true), 200);
    const strokeTimer = setTimeout(() => setDrawStroke(true), 500);

    return () => {
      clearTimeout(fillTimer);
      clearTimeout(strokeTimer);
    };
  }, [phase, animate]);

  useEffect(() => {
    const el = strokeRef.current;
    if (!el) return;

    if (drawStroke) {
      const length = el.getTotalLength();
      el.style.strokeDasharray = `${length}`;
      el.style.strokeDashoffset = `${length}`;
      el.getBoundingClientRect();
      el.style.transition = 'stroke-dashoffset 2.5s ease-in-out';
      el.style.strokeDashoffset = '0';
    } else {
      el.style.transition = 'none';
      const length = el.getTotalLength();
      el.style.strokeDasharray = `${length}`;
      el.style.strokeDashoffset = `${length}`;
    }
  }, [drawStroke]);

  if (!data) return null;

  return (
    <svg
      viewBox={data.viewBox}
      width={size}
      height={size}
      xmlns="http://www.w3.org/2000/svg"
    >
      <g>
        <path
          d={data.fill}
          fill="#3cf281"
          style={{
            opacity: showFill ? 1 : 0,
            transition: 'opacity 0.5s ease-in',
          }}
        />
        <path
          ref={strokeRef}
          d={data.stroke}
          fill="none"
          stroke={strokeColor}
          strokeWidth={data.strokeWidth}
          strokeLinecap="round"
          strokeMiterlimit={10}
          style={{
            opacity: drawStroke ? 1 : 0,
          }}
        />
      </g>
    </svg>
  );
}
